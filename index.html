<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Juice Hub ‚Äî Kiosk & Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- jsPDF for PDF generation -->
  <style>
    :root{--primary:#F87171;--accent:#6EE7B7}
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:#f7f7f7}
    .modal-bg{background:rgba(0,0,0,.56);backdrop-filter:blur(4px);z-index:60}
    .juice-card{transition:transform .18s,box-shadow .18s}
    .juice-card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .center-modal{display:flex;align-items:center;justify-content:center}
    .stepper-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body class="min-h-screen">

  <div id="app" class="relative">
    <header class="bg-white shadow-md sticky top-0 z-40">
      <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
          <span class="text-4xl mr-2" style="color:var(--primary-color)">üçπ</span>
          Juice Hub
        </h1>
        <div id="cart-icon-container" class="relative cursor-pointer md:hidden" onclick="toggleCartPanel()">
          <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
               xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
               d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          <span id="mobile-cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center opacity-0 transition-opacity">0</span>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-8 py-6 px-4 sm:px-6 lg:px-8">
      <div id="content-area-wrapper" class="md:col-span-8 lg:col-span-9">
        <div id="content-area"></div>
      </div>

      <div id="cart-panel-desktop-wrapper" class="hidden md:block md:col-span-4 lg:col-span-3">
        <div id="cart-panel-desktop" class="sticky top-6 bg-white rounded-xl shadow-lg h-[calc(100vh-6rem)] flex flex-col overflow-hidden"></div>
      </div>
    </div>

    <div id="cart-panel-mobile" class="cart-panel-mobile fixed inset-y-0 right-0 w-full max-w-sm bg-white shadow-2xl flex flex-col transform translate-x-full transition-transform md:hidden z-50"></div>

    <!-- Login modal: ask name + phone -->
    <div id="phone-modal" class="fixed inset-0 modal-bg flex items-center justify-center p-4 transition-opacity duration-300">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-transform duration-300 scale-100">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-4" style="color:var(--primary-color)">Welcome to Juice Hub!</h2>
        <p class="text-gray-600 mb-4">Enter name and mobile to start. Your bill will be sent via WhatsApp after payment.</p>

        <input id="name-input" type="text" placeholder="Your name" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 text-lg focus:border-red-400">
        <input id="mobile-input" type="tel" placeholder="e.g., 9876543210" maxlength="10" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 text-lg focus:border-red-400">
        <div class="flex gap-3">
          <button id="start-order-btn" class="flex-1 p-3 text-lg font-bold text-white rounded-lg add-btn disabled:opacity-50" disabled>Start Ordering</button>
        </div>
        <p id="phone-error" class="text-red-500 text-sm mt-3 hidden">Please enter a valid name and 10-digit phone.</p>
      </div>
    </div>

    <!-- Message modal -->
    <div id="message-modal" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 transition-opacity duration-300 opacity-0">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300">
        <h3 id="message-modal-title" class="text-xl font-bold mb-3 text-red-500"></h3>
        <p id="message-modal-body" class="text-gray-600 mb-6"></p>
        <button onclick="closeMessageModal()" class="w-full p-2 font-semibold text-white rounded-lg bg-gray-500 hover:bg-gray-600">Got It</button>
      </div>
    </div>

    <!-- QR Payment Modal -->
    <div id="qr-modal" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 transition-opacity duration-300">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-100">
        <h3 class="text-2xl font-bold mb-2" style="color:var(--primary-color)">UPI Payment</h3>
        <p id="qr-amount" class="text-gray-600 mb-4"></p>

        <!-- Sample QR (embedded base64 PNG placeholder) -->
        <div class="flex justify-center mb-4">
          <img id="sample-qr" src="" alt="Sample QR" class="w-48 h-48 object-contain bg-white p-3 border rounded-md">
        </div>

        <div class="text-sm text-gray-700 mb-4">
          <p>Scan the QR with any UPI app and pay the payable amount.</p>
          <p class="mt-2">After paying, click <strong>Payment Done</strong>.</p>
        </div>

        <div class="flex gap-3">
          <button onclick="onPaymentDone()" class="flex-1 p-3 text-lg font-bold text-white rounded-lg bg-green-600">Payment Done</button>
          <button onclick="closeQRModal()" class="flex-1 p-3 text-lg font-bold rounded-lg border">Cancel</button>
        </div>
      </div>
    </div>

  </div>

<script>
  // --- Constants and initial data ---
  const APP_TAX_RATE = 0.05;
  const INITIAL_STOCK = 10;
  const JUICES = [
    { id: 1, name: 'Mango Juice', price: 60, icon: 'ü•≠' },
    { id: 2, name: 'Watermelon', price: 50, icon: 'üçâ' },
    { id: 3, name: 'Orange Juice', price: 55, icon: 'üçä' },
    { id: 4, name: 'Pineapple', price: 65, icon: 'üçç' },
    { id: 5, name: 'Mix Fruit', price: 75, icon: 'üçéüçå' },
    { id: 6, name: 'Strawberry', price: 80, icon: 'üçì' },
    { id: 7, name: 'Apple Delight', price: 70, icon: 'üçè' },
    { id: 8, name: 'Grapes', price: 60, icon: 'üçá' },
    { id: 9, name: 'Banana Shake', price: 85, icon: 'üçå' },
    { id: 10, name: 'Chikoo Milkshake', price: 90, icon: 'üßã' },
  ];

  let state = {
    view: 'phone_entry',
    mobileNumber: '',
    userName: '',
    userPoints: 0,
    cart: [],
    stock: {},
    orderType: 'Dine-in',
    paymentMethod: 'UPI Payment',
    subtotal: 0,
    grandTotal: 0,
    isCartOpen: false,
    redeemed: false
  };

  // DOM
  const contentArea = document.getElementById('content-area');
  const phoneModal = document.getElementById('phone-modal');
  const nameInput = document.getElementById('name-input');
  const mobileInput = document.getElementById('mobile-input');
  const startOrderBtn = document.getElementById('start-order-btn');
  const phoneError = document.getElementById('phone-error');
  const cartPanelDesktop = document.getElementById('cart-panel-desktop');
  const cartPanelMobile = document.getElementById('cart-panel-mobile');
  const mobileCartBadge = document.getElementById('mobile-cart-badge');
  const messageModal = document.getElementById('message-modal');
  const messageModalTitle = document.getElementById('message-modal-title');
  const messageModalBody = document.getElementById('message-modal-body');
  const qrModal = document.getElementById('qr-modal');
  const sampleQRImg = document.getElementById('sample-qr');
  const qrAmountText = document.getElementById('qr-amount');

  // --- Storage helpers for members ---
  function loadMembers() {
    return JSON.parse(localStorage.getItem('juice_members') || '{}');
  }
  function saveMembers(members) {
    localStorage.setItem('juice_members', JSON.stringify(members));
  }

  // --- Stock management (localStorage) ---
  function initializeStock() {
    const storedStock = localStorage.getItem('juiceShopStock');
    if (storedStock) {
      state.stock = JSON.parse(storedStock);
    } else {
      JUICES.forEach(j => state.stock[j.id] = INITIAL_STOCK);
      saveStock();
    }
  }
  function saveStock() {
    localStorage.setItem('juiceShopStock', JSON.stringify(state.stock));
  }
  function finalizeOrderStockReduction() {
    state.cart.forEach(item => {
      const cur = state.stock[item.id] || 0;
      state.stock[item.id] = Math.max(0, cur - item.qty);
    });
    saveStock();
  }

  // --- Totals & cart logic ---
  function updateTotals() {
    state.subtotal = state.cart.reduce((s,i)=> s + (i.price*i.qty), 0);
    state.grandTotal = state.subtotal * (1 + APP_TAX_RATE);
    renderCartPanel();
  }

  function addToCart(productId) {
    const product = JUICES.find(j=>j.id===productId);
    if(!product) return;
    const cartItem = state.cart.find(c=>c.id===productId);
    const currentStock = state.stock[productId] || 0;
    const newQty = (cartItem?cartItem.qty:0) + 1;
    if(newQty > currentStock) {
      showMessageModal('Stock Limited', `Only ${currentStock} items available.`);
      return;
    }
    if(cartItem) cartItem.qty = newQty;
    else state.cart.push({ id:product.id, name:product.name, price:product.price, qty:1 });
    updateTotals();
    renderProductList();
    if(state.cart.length===1 && window.innerWidth<768) toggleCartPanel(true);
  }

  function updateCartQuantity(productId, delta) {
    const item = state.cart.find(i=>i.id===productId);
    if(!item) return;
    const currentStock = state.stock[productId] || 0;
    const newQty = item.qty + delta;
    if(newQty > currentStock){ showMessageModal('Stock Limited', `Only ${currentStock} items available.`); return; }
    if(newQty<=0) removeFromCart(productId);
    else { item.qty = newQty; updateTotals(); }
    renderProductList();
  }

  function removeFromCart(productId) {
    state.cart = state.cart.filter(i=>i.id!==productId);
    updateTotals();
    renderProductList();
    if(state.cart.length===0 && window.innerWidth<768) toggleCartPanel(false);
  }

  // --- UI Rendering ---
  function renderUserInfoHTML() {
    if(!state.userName) return '';
    return `<div class="mb-4 p-4 bg-white rounded-xl shadow">
      <div class="flex justify-between items-center">
        <div>
          <div class="font-semibold text-gray-800">Member: ${escapeHtml(state.userName)}</div>
          <div class="text-sm text-gray-500">+91 ${state.mobileNumber}</div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500">Points</div>
          <div class="font-bold text-lg text-gray-800">${state.userPoints}</div>
        </div>
      </div>
    </div>`;
  }

  function renderProductList() {
    if(state.view !== 'ordering') return;
    const cartItemIds = state.cart.map(i=>i.id);
    const productListHTML = JUICES.map(juice=>{
      const inCart = cartItemIds.includes(juice.id);
      const item = state.cart.find(i=>i.id===juice.id);
      const currentStock = state.stock[juice.id] || 0;
      const out = currentStock===0;
      return `<div class="juice-card bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between ${out?'opacity-50 grayscale':''}">
        <div>
          <div class="text-4xl mb-3">${juice.icon}</div>
          <h3 class="text-xl font-bold text-gray-900">${juice.name}</h3>
          <p class="text-2xl font-extrabold text-red-500 mt-1">‚Çπ${juice.price}</p>
          <p class="text-sm text-gray-500 mt-1">Stock: ${currentStock}</p>
        </div>
        <div id="controls-${juice.id}" class="mt-4">
          ${inCart ? `<div class="stepper-ui active justify-center p-1 border-2 border-red-400 rounded-lg">
            <button onclick="updateCartQuantity(${juice.id}, -1)" class="bg-red-400 text-white rounded-md p-1 font-bold w-8 h-8">-</button>
            <span class="text-lg font-bold text-gray-800 mx-4">${item.qty}</span>
            <button onclick="updateCartQuantity(${juice.id}, 1)" class="bg-red-400 text-white rounded-md p-1 font-bold w-8 h-8">+</button>
          </div>` : `<button onclick="addToCart(${juice.id})" class="add-btn w-full p-2 text-lg font-bold text-white rounded-lg shadow-md ${out?'bg-gray-400 cursor-not-allowed':''}" ${out?'disabled':''}>${out?'Out of Stock':'Add'}</button>`}
        </div>
      </div>`;
    }).join('');
    contentArea.innerHTML = `${renderUserInfoHTML()}<div class="mb-6 text-center">
      <h2 class="text-3xl font-extrabold text-gray-900">Select Your Juices</h2>
      <p class="text-gray-500">Freshly made just for you.</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${productListHTML}</div>`;
    renderCartPanel();
  }

  function renderCartPanel() {
    const taxAmount = state.subtotal * APP_TAX_RATE;
    const cartItemsHTML = state.cart.length>0 ? state.cart.map(item=>`
      <div id="cart-item-${item.id}" class="flex items-center justify-between py-3 border-b border-gray-100">
        <div class="flex flex-col flex-grow">
          <span class="text-gray-800 font-semibold">${item.name}</span>
          <span class="text-sm text-gray-500">@ ‚Çπ${item.price}</span>
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="updateCartQuantity(${item.id}, -1)" class="text-red-400 font-bold text-xl">-</button>
          <span class="font-bold text-gray-700 w-6 text-center">${item.qty}</span>
          <button onclick="updateCartQuantity(${item.id}, 1)" class="text-red-400 font-bold text-xl">+</button>
        </div>
        <span class="font-bold text-gray-900 w-16 text-right">‚Çπ${(item.price * item.qty).toFixed(0)}</span>
        <button onclick="removeFromCart(${item.id})" class="ml-3 text-gray-300 hover:text-red-500">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    `).join('') : `<div class="text-center py-10 text-gray-500"><span class="text-4xl block mb-2">üõí</span>Your cart is empty.</div>`;

    const cartContentHTML = (isMobile)=>`
      <div class="p-6 pb-2 border-b-2 border-red-400 flex justify-between items-center">
        <h2 class="text-2xl font-extrabold text-gray-900">Your Order</h2>
        ${isMobile ? `<button class="md:hidden text-gray-500 hover:text-gray-800" onclick="toggleCartPanel(false)"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>` : ''}
      </div>
      <div class="flex-grow p-6 overflow-y-auto scrollable-content">${cartItemsHTML}</div>
      <div class="p-6 bg-gray-50 border-t border-gray-200">
        <div class="space-y-1 text-sm">
          <div class="flex justify-between font-medium text-gray-700"><span>Subtotal:</span><span>‚Çπ${state.subtotal.toFixed(0)}</span></div>
          <div class="flex justify-between text-gray-500"><span>Tax (5%):</span><span>+ ‚Çπ${taxAmount.toFixed(0)}</span></div>
          <div class="flex justify-between text-xl font-extrabold pt-2 text-gray-900"><span>Grand Total:</span><span class="text-red-500">‚Çπ${state.grandTotal.toFixed(0)}</span></div>
          <p class="text-xs text-gray-500 mt-1">Mobile: ${state.mobileNumber}</p>
        </div>
        <button onclick="handleCheckoutClick()" class="w-full mt-4 p-3 text-lg font-bold text-white rounded-lg shadow-xl add-btn" ${state.cart.length===0?'disabled':''}>Checkout (${state.cart.length} items)</button>
      </div>
    `;
    if(cartPanelDesktop) cartPanelDesktop.innerHTML = cartContentHTML(false);
    if(cartPanelMobile) cartPanelMobile.innerHTML = cartContentHTML(true);

    const totalItems = state.cart.reduce((s,i)=>s+i.qty,0);
    mobileCartBadge.textContent = totalItems;
    mobileCartBadge.classList.toggle('opacity-0', totalItems===0);
  }
  // create ADMIN_BILL state on window
  window.ADMIN_BILL = {
    name,
    phone,
    points: 0,
    cart: [],
    orderType: 'Dine-in',
    redeem: false
  };
  if(phone){
    const members = loadMembers();
    if(!members[phone]) members[phone] = { name, points: 0, orders: [] };
    window.ADMIN_BILL.points = members[phone].points || 0;
    saveMembers(members);
  }
  // remove overlay
  const overlay = document.getElementById('admin-billing-start-overlay');
  if(overlay) overlay.remove();
  // render billing UI inside admin-content (same style as customer)
  renderAdminBillingUI();
}

/* Render Admin Billing UI (cards + order panel) */
function renderAdminBillingUI(){
  const juices = loadJuices();
  const productCards = juices.map(j=> {
    const inCart = (window.ADMIN_BILL.cart || []).find(c=>c.id===j.id);
    const out = j.stock <= 0;
    return `<div class="juice-card bg-white rounded-2xl p-5 shadow">
      <div class="flex items-start gap-4">
        <div class="text-4xl">${j.icon||'üçπ'}</div>
        <div class="flex-1">
          <div class="font-bold text-lg">${esc(j.name)}</div>
          <div class="text-red-500 font-extrabold text-xl">‚Çπ${j.price}</div>
          <div class="text-sm text-gray-500">Stock: ${j.stock}</div>
        </div>
      </div>

      <div class="mb-6"><h3 class="text-xl font-bold mb-3 text-gray-800">Order Type</h3>
        <div class="flex space-x-4">
          <button onclick="state.orderType='Dine-in'; renderCheckoutPage();" class="flex-1 p-4 rounded-lg font-semibold transition-all shadow-md ${state.orderType==='Dine-in'?'bg-red-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Dine-in üçΩÔ∏è</button>
          <button onclick="state.orderType='Parcel'; renderCheckoutPage();" class="flex-1 p-4 rounded-lg font-semibold transition-all shadow-md ${state.orderType==='Parcel'?'bg-red-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Parcel (Takeaway) üì¶</button>
        </div>
      </div>

      <div class="mb-8"><h3 class="text-xl font-bold mb-3 text-gray-800">Payment</h3>
        <div class="space-y-3">
          <div class="flex items-center p-4 rounded-lg border-2 cursor-pointer transition-colors ${state.paymentMethod==='UPI Payment'?'border-red-500 bg-red-50':'border-gray-300 hover:border-red-400'}" onclick="state.paymentMethod='UPI Payment'; renderCheckoutPage();">
            <input type="radio" name="payment" id="upi" value="UPI Payment" class="h-5 w-5 text-red-600" ${state.paymentMethod==='UPI Payment'?'checked':''}><label for="upi" class="ml-3 text-lg font-semibold text-gray-900">UPI Payment (QR)</label>
          </div>
          <div class="flex items-center p-4 rounded-lg border-2 cursor-pointer transition-colors ${state.paymentMethod==='Cash'?'border-red-500 bg-red-50':'border-gray-300 hover:border-red-400'}" onclick="state.paymentMethod='Cash'; renderCheckoutPage();">
            <input type="radio" name="payment" id="cash" value="Cash" class="h-5 w-5 text-red-600" ${state.paymentMethod==='Cash'?'checked':''}><label for="cash" class="ml-3 text-lg font-semibold text-gray-900">Cash on Delivery</label>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${productCards}</div>
      </div>

      <div class="mb-4 ${canRedeem?'':'hidden'}"><label class="flex items-center gap-3"><input id="redeem-checkbox" type="checkbox" class="h-4 w-4" onchange="onRedeemToggle(this.checked)"><span class="text-sm text-gray-700">Redeem 100 points for ‚Çπ50 discount</span></label></div>

      <button onclick="startPaymentFlow()" class="w-full p-4 text-xl font-extrabold text-white rounded-lg shadow-xl" style="background-color:var(--primary-color)">${state.paymentMethod==='UPI Payment'?'Pay & Generate Bill':'Confirm & Generate Bill'}: ‚Çπ${state.grandTotal.toFixed(0)}</button>
    </div>`;

    // ensure discount row visibility toggles based on checkbox
    document.getElementById('redeem-checkbox')?.checked && onRedeemToggle(document.getElementById('redeem-checkbox').checked);
  }

  // --- Payment flow (sample QR & simulate) ---
  // Provide a small sample QR as base64 png (placeholder)
  const SAMPLE_QR_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAABmklEQVR4nO3RAQ0AAAgDoJvc6F9hgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4D0oAARr0o3gAAAAASUVORK5CYII=';

  function startPaymentFlow() {
    // Apply redeem logic before showing QR
    // If redeem chosen reduce amount by 50
    // Build payable amount in state.grandTotal
    // Show QR modal if UPI or if Cash -> directly simulate success
    if (state.paymentMethod === 'UPI Payment') {
      // populate qr modal
      qrAmountText.innerText = `Amount to pay: ‚Çπ${state.grandTotal.toFixed(0)}`;
      sampleQRImg.src = SAMPLE_QR_BASE64;
      openQRModal();
    } else {
      // For cash, treat as immediate success
      onPaymentDone();
    }
  }

  function openQRModal() {
    qrModal.classList.remove('hidden');
    qrModal.classList.add('flex');
  }
  function closeQRModal() {
    qrModal.classList.add('hidden');
    qrModal.classList.remove('flex');
  }

  // Called when user clicks Payment Done
  async function onPaymentDone() {
    closeQRModal();

    // 1. Reduce stock
    finalizeOrderStockReduction();

    // 2. Update points
    const members = loadMembers();
    const m = members[state.mobileNumber] || {name: state.userName, phone: state.mobileNumber, points:0};
    if (state.redeemed) {
      // per your requirement: after redeem it should start with 1 again
      m.points = 1;
    } else {
      m.points = (m.points || 0) + 1;
    }
    members[state.mobileNumber] = m;
    saveMembers(members);
    state.userPoints = m.points;
    // 4. Generate WhatsApp message (text preview) and open
    const billText = generateWhatsAppBill();
    const encoded = encodeURIComponent(billText);
    const waLink = `https://wa.me/91${state.mobileNumber}?text=${encoded}`;
    // open wa in new tab
    window.open(waLink, '_blank');

    // 5. Show confirmation screen and reset cart
    setView('bill');

    // clear cart
    state.cart = [];
    updateTotals();
    renderProductList();
    state.redeemed = false;
  }

  // --- Bill message generation (text) ---
  function generateWhatsAppBill() {
    const itemLines = state.cart.map(i=> `${i.name} x ${i.qty} = ‚Çπ${(i.price*i.qty).toFixed(0)}`).join('\n');
    const taxAmount = state.subtotal * APP_TAX_RATE;
    const orderTypeStatus = state.orderType === 'Dine-in' ? 'Dine-In üçΩÔ∏è' : 'Parcel (Takeaway) üì¶';
    const thankYou = state.orderType === 'Dine-in' ? 'Thank you! Your juice will be served shortly. üçπ' : 'Thank you! Collect your parcel at the counter. üì¶';
    let discountLine = state.redeemed ? '\nDiscount (Redeem 100 pts): -‚Çπ50' : '';
    return `*üçπ Juice Shop Bill*\n---------------------------------\n${itemLines}\n---------------------------------\nSubtotal: ‚Çπ${state.subtotal.toFixed(0)}\nTax (5%): ‚Çπ${taxAmount.toFixed(0)}${discountLine}\n*Total Amount: ‚Çπ${state.grandTotal.toFixed(0)}*\nPayment Mode: ${state.paymentMethod}\nOrder Type: ${orderTypeStatus}\n---------------------------------\n${thankYou}`;
  }

  // --- UI control helpers ---
  function setView(newView) {
    state.view = newView;
    document.getElementById('cart-icon-container').classList.toggle('hidden', newView !== 'ordering');
    const desktopCartWrapper = document.getElementById('cart-panel-desktop-wrapper');
    if (desktopCartWrapper) desktopCartWrapper.classList.toggle('hidden', newView !== 'ordering');
    switch(newView) {
      case 'ordering': renderProductList(); break;
      case 'checkout': renderCheckoutPage(); break;
      case 'bill': renderBillConfirmation(); break;
    }
  }

  function toggleCartPanel(forceState) {
    state.isCartOpen = (typeof forceState === 'boolean') ? forceState : !state.isCartOpen;
    cartPanelMobile.classList.toggle('translate-x-full', !state.isCartOpen);
  }

  function showMessageModal(title, body) {
    messageModalTitle.textContent = title;
    messageModalBody.textContent = body;
    messageModal.classList.remove('hidden','opacity-0');
    messageModal.classList.add('flex','opacity-100');
  }
  function closeMessageModal() {
    messageModal.classList.remove('opacity-100');
    messageModal.classList.add('opacity-0');
    setTimeout(()=>{ messageModal.classList.remove('flex'); messageModal.classList.add('hidden'); },300);
  }

  // --- Event handlers for login ---
  function handleNamePhoneInput() {
    const num = mobileInput.value.replace(/\D/g,'');
    mobileInput.value = num;
    const name = nameInput.value.trim();
    if(num.length===10 && name.length>0) { startOrderBtn.disabled=false; phoneError.classList.add('hidden'); }
    else { startOrderBtn.disabled=true; }
  }

  function handleStartOrder() {
    const num = mobileInput.value.trim(); const name = nameInput.value.trim();
    if(num.length===10 && name.length>0) {
      state.mobileNumber = num; state.userName = name;
      // load or create member
      const members = loadMembers();
      if(!members[num]) { members[num] = { name: name, phone: num, points: 0 }; saveMembers(members); }
      state.userPoints = members[num].points;
      phoneModal.classList.add('opacity-0');
      setTimeout(()=>{ phoneModal.classList.add('hidden'); setView('ordering'); },300);
    } else phoneError.classList.remove('hidden');
  }

  // Checkout click
  function handleCheckoutClick(){ if(state.cart.length>0) setView('checkout'); }

  // redeem toggle handler
  function onRedeemToggle(checked) {
    state.redeemed = !!checked;
    // if redeemed, deduct 100 and apply discount immediately (and set grandTotal)
    if(state.redeemed) {
      // apply fixed ‚Çπ50 discount
      const subtotal = state.subtotal;
      const tax = subtotal * APP_TAX_RATE;
      const newTotal = subtotal + tax - 50;
      state.grandTotal = Math.max(0, newTotal);
    } else {
      state.grandTotal = state.subtotal * (1 + APP_TAX_RATE);
    }
    // update checkout view numbers
    renderCheckoutPage();
  }
  const msg = formatBillText(order, true);
  if(order.customerPhone && order.customerPhone !== 'N/A') window.open(`https://wa.me/91${order.customerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
  alert('Bill generated JH-' + String(id).padStart(4,'0'));
  window.ADMIN_BILL = null;
  adminNavigate('history');
}

/* -----------------------
   Utilities & init
   ----------------------- */
function loadJuices(){ return JSON.parse(localStorage.getItem(LS.JUICES) || '[]'); }
function saveJuices(arr){ localStorage.setItem(LS.JUICES, JSON.stringify(arr)); }
function loadMembers(){ return JSON.parse(localStorage.getItem(LS.MEMBERS) || '{}'); }
function saveMembers(map){ localStorage.setItem(LS.MEMBERS, JSON.stringify(map)); }
function loadOrders(){ return JSON.parse(localStorage.getItem(LS.ORDERS) || '[]'); }
function saveOrders(arr){ localStorage.setItem(LS.ORDERS, JSON.stringify(arr)); }
function getOwner(){ return JSON.parse(localStorage.getItem(LS.OWNER) || '{}'); }

document.addEventListener('DOMContentLoaded', ()=> {
  // ready
});
</script>
</body>
</html>
