<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Juice Hub ‚Äî Kiosk & Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#F87171;--accent:#6EE7B7}
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:#f7f7f7}
    .modal-bg{background:rgba(0,0,0,.56);backdrop-filter:blur(4px);z-index:60}
    .juice-card{transition:transform .18s,box-shadow .18s}
    .juice-card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .center-modal{display:flex;align-items:center;justify-content:center}
    .stepper-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body class="min-h-screen">

<div id="app">

  <!-- Mode Select -->
  <div id="mode-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-extrabold mb-2" style="color:var(--primary)">üçπ Juice Hub</h1>
      <p class="text-gray-600 mb-6">Choose mode: Customer (Kiosk) or Shop Owner (Admin).</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <button onclick="enterCustomerMode()" class="p-6 rounded-xl border hover:shadow-sm text-left">
          <div class="text-xl font-bold">I'm a Customer</div>
          <div class="text-sm text-gray-500 mt-1">Place an order on the kiosk ‚Äî name & phone required.</div>
        </button>
        <button onclick="enterOwnerMode()" class="p-6 rounded-xl border hover:shadow-sm text-left">
          <div class="text-xl font-bold">I'm the Shop Owner</div>
          <div class="text-sm text-gray-500 mt-1">Open admin dashboard (Shopname & password).</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Customer Screen -->
  <div id="customer-screen" class="hidden min-h-screen">
    <header class="bg-white shadow sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div style="color:var(--primary)" class="text-4xl">üçπ</div>
          <div>
            <h2 class="text-2xl font-extrabold">Juice Hub</h2>
            <div class="text-sm text-gray-500">Freshly made ‚Äî kiosk</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div id="cust-header-info" class="text-right text-sm"></div>
          <button onclick="returnToMode()" class="px-3 py-2 rounded border">Exit</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 md:grid-cols-12 gap-6">
      <section class="md:col-span-8 lg:col-span-9">
        <div id="cust-top-area" class="mb-6"></div>

        <div class="mb-6 flex gap-3">
          <div class="bg-white p-4 rounded-2xl shadow flex items-center gap-4">
            <div class="font-semibold">Order Type:</div>
            <div class="flex items-center gap-2">
              <button id="dine-btn" onclick="setOrderType('Dine-in')" class="px-4 py-2 rounded-lg border bg-white">Dine-in</button>
              <button id="parcel-btn" onclick="setOrderType('Parcel')" class="px-4 py-2 rounded-lg border bg-white">Parcel (+‚Çπ10)</button>
            </div>
          </div>
        </div>

        <div id="product-area"></div>
      </section>

      <aside class="md:col-span-4 lg:col-span-3">
        <div id="cart-panel" class="bg-white rounded-2xl shadow p-4 sticky top-6">
          <h3 class="font-bold text-lg">Your Order</h3>
          <div id="cart-list" class="mt-3 space-y-3"></div>
          <div id="cart-summary" class="mt-4 text-sm"></div>
          <div class="mt-4">
            <button id="open-checkout-btn" onclick="openCheckout('customer')" class="w-full bg-red-500 text-white p-3 rounded-lg disabled:opacity-50" disabled>Checkout</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Customer Login Modal -->
  <div id="cust-login-modal" class="fixed inset-0 modal-bg hidden center-modal p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition">
      <h3 class="text-2xl font-bold mb-2" style="color:var(--primary)">Welcome ‚Äî Please enter details</h3>
      <p class="text-gray-600 mb-4">We will send your bill via WhatsApp.</p>
      <input id="input-name" class="w-full border rounded p-3 mb-3" placeholder="Your name">
      <input id="input-phone" class="w-full border rounded p-3 mb-3" placeholder="10-digit mobile number" maxlength="10">
      <div class="flex gap-3">
        <button id="start-order" class="flex-1 bg-red-500 text-white p-3 rounded disabled:opacity-50" disabled onclick="startCustomer()">Start Ordering</button>
        <button class="flex-1 border p-3 rounded" onclick="cancelCustomerLogin()">Cancel</button>
      </div>
      <p id="cust-login-error" class="text-red-500 text-sm mt-3 hidden">Please enter valid details.</p>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 modal-bg hidden center-modal p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6">
      <h3 class="text-2xl font-bold mb-3" style="color:var(--primary)">Final Checkout</h3>
      <div id="checkout-items" class="text-sm mb-4 max-h-56 overflow-y-auto"></div>

      <div class="mb-3">
        <div class="flex gap-3">
          <label class="flex items-center gap-2"><input type="radio" name="co-order-type" value="Dine-in" onchange="checkoutSetOrderType('Dine-in')"> Dine-in</label>
          <label class="flex items-center gap-2"><input type="radio" name="co-order-type" value="Parcel" onchange="checkoutSetOrderType('Parcel')"> Parcel (+‚Çπ10)</label>
        </div>
      </div>

      <div id="checkout-redeem" class="mb-3 hidden">
        <label class="flex items-center gap-2"><input id="checkout-redeem-checkbox" type="checkbox"> Redeem 100 points for ‚Çπ50 off</label>
      </div>

      <div id="checkout-summary" class="mb-4 text-sm"></div>

      <div class="flex gap-3">
        <button id="checkout-pay-btn" class="flex-1 bg-red-500 text-white p-3 rounded" onclick="checkoutPayClicked('customer')">Pay & Generate Bill</button>
        <button class="flex-1 border p-3 rounded" onclick="closeCheckout()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qr-modal" class="fixed inset-0 modal-bg hidden center-modal p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
      <h3 class="text-xl font-bold mb-2" style="color:var(--primary)">UPI Payment (Sample)</h3>
      <p id="qr-amt" class="text-gray-700 mb-3"></p>
      <img id="qr-img" src="" alt="QR" class="mx-auto w-48 h-48 bg-white p-2 rounded" />
      <p class="text-sm text-gray-500 mt-3">Scan & pay via UPI app, then click <strong>Payment Done</strong>.</p>
      <div class="flex gap-3 mt-4">
        <button onclick="paymentDone()" class="flex-1 bg-green-600 text-white p-3 rounded">Payment Done</button>
        <button onclick="closeQR()" class="flex-1 border p-3 rounded">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 modal-bg hidden center-modal p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 text-center">
      <div class="text-6xl text-green-500 mb-3">‚úÖ</div>
      <h3 class="text-2xl font-bold mb-2">Order Placed</h3>
      <p class="text-gray-600 mb-4">Bill is opened in WhatsApp. Order ID: <span id="success-orderid"></span></p>
      <button class="bg-gray-100 px-4 py-2 rounded" onclick="closeSuccess()">OK</button>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-login-modal" class="fixed inset-0 modal-bg hidden center-modal p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <h3 class="text-2xl font-bold mb-2" style="color:var(--primary)">Admin Login</h3>
      <p class="text-gray-600 mb-4">Enter shop name and password.</p>
      <input id="admin-shopname" class="w-full border rounded p-3 mb-3" placeholder="Shop Name (e.g., JuiceHub)">
      <input id="admin-pass" type="password" class="w-full border rounded p-3 mb-3" placeholder="Password">
      <div class="flex gap-3">
        <button class="flex-1 bg-gray-800 text-white p-3 rounded" onclick="adminLogin()">Login</button>
        <button class="flex-1 border p-3 rounded" onclick="closeAdminLogin()">Cancel</button>
      </div>
      <p id="admin-login-error" class="text-red-500 text-sm mt-3 hidden">Invalid credentials</p>
    </div>
  </div>

  <!-- Admin Screen -->
  <div id="admin-screen" class="hidden min-h-screen flex bg-gray-50">
    <aside class="w-72 bg-white p-4 border-r min-h-screen">
      <div class="mb-6">
        <div id="admin-shop-title" class="text-xl font-extrabold" style="color:var(--primary)">Juice Hub</div>
        <div id="admin-sub" class="text-sm text-gray-500">Owner Panel</div>
      </div>
      <nav class="space-y-2">
        <button id="nav-dashboard" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('dashboard')">Dashboard</button>
        <button id="nav-orders" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('orders')">Orders (Pending)</button>
        <button id="nav-history" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('history')">Order History</button>
        <button id="nav-customers" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('customers')">Customers</button>
        <button id="nav-juices" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('juices')">Juices Inventory</button>
        <button id="nav-billing" class="w-full text-left p-3 rounded hover:bg-gray-100" onclick="adminNavigate('billing')">Billing (Walk-in)</button>
        <button class="w-full text-left p-3 rounded text-red-600 hover:bg-gray-100" onclick="adminLogout()">Logout</button>
      </nav>
    </aside>

    <main id="admin-content" class="flex-1 p-6"></main>
  </div>

</div>

<script>
/* -----------------------
   LocalStorage keys & init
   ----------------------- */
const LS = {
  JUICES: 'jh_juices',
  MEMBERS: 'jh_members',
  ORDERS: 'jh_orders',
  ORDERID: 'jh_orderid',
  OWNER: 'jh_owner'
};
const SAMPLE_QR = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAABmklEQVR4nO3RAQ0AAAgDoJvc6F9hgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4D0oAARr0o3gAAAAASUVORK5CYII=';

function initDefaults(){
  if(!localStorage.getItem(LS.JUICES)){
    const defaultJs = [
      { id:1, name:'Mango Juice', price:60, stock:10, icon:'ü•≠' },
      { id:2, name:'Watermelon', price:50, stock:10, icon:'üçâ' },
      { id:3, name:'Orange Juice', price:55, stock:10, icon:'üçä' },
      { id:4, name:'Pineapple', price:65, stock:10, icon:'üçç' },
      { id:5, name:'Mix Fruit', price:75, stock:10, icon:'üçé' },
      { id:6, name:'Strawberry', price:80, stock:10, icon:'üçì' }
    ];
    localStorage.setItem(LS.JUICES, JSON.stringify(defaultJs));
  }
  if(!localStorage.getItem(LS.MEMBERS)) localStorage.setItem(LS.MEMBERS, JSON.stringify({}));
  if(!localStorage.getItem(LS.ORDERS)) localStorage.setItem(LS.ORDERS, JSON.stringify([]));
  if(!localStorage.getItem(LS.ORDERID)) localStorage.setItem(LS.ORDERID, '1');
  if(!localStorage.getItem(LS.OWNER)) localStorage.setItem(LS.OWNER, JSON.stringify({ shop: 'JuiceHub', pass: '1234' }));
}
initDefaults();

/* helpers */
function loadJuices(){ return JSON.parse(localStorage.getItem(LS.JUICES) || '[]'); }
function saveJuices(arr){ localStorage.setItem(LS.JUICES, JSON.stringify(arr)); }
function loadMembers(){ return JSON.parse(localStorage.getItem(LS.MEMBERS) || '{}'); }
function saveMembers(map){ localStorage.setItem(LS.MEMBERS, JSON.stringify(map)); }
function loadOrders(){ return JSON.parse(localStorage.getItem(LS.ORDERS) || '[]'); }
function saveOrders(arr){ localStorage.setItem(LS.ORDERS, JSON.stringify(arr)); }
function getOrderID(){ return Number(localStorage.getItem(LS.ORDERID) || '1'); }
function nextOrderID(){ const id = getOrderID(); localStorage.setItem(LS.ORDERID, String(id+1)); return id; }
function getOwner(){ return JSON.parse(localStorage.getItem(LS.OWNER) || '{}'); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* -----------------------
   App states
   ----------------------- */
let MODE = null; // 'customer' | 'admin'
let CUSTOMER = { name:'', phone:'', points:0, cart:[], orderType:'Dine-in', redeem:false, paymentMode:'UPI' };

/* -----------------------
   Mode switch
   ----------------------- */
function enterCustomerMode(){
  MODE = 'customer';
  document.getElementById('mode-screen').classList.add('hidden');
  document.getElementById('customer-screen').classList.remove('hidden');
  showCustomerLogin();
  renderProducts();
  renderCart();
}
function enterOwnerMode(){
  MODE = 'admin';
  document.getElementById('mode-screen').classList.add('hidden');
  document.getElementById('admin-login-modal').classList.remove('hidden');
  document.getElementById('admin-shopname').value = getOwner().shop || 'JuiceHub';
}
function returnToMode(){
  MODE = null;
  document.getElementById('customer-screen').classList.add('hidden');
  document.getElementById('admin-screen').classList.add('hidden');
  document.getElementById('mode-screen').classList.remove('hidden');
  CUSTOMER = { name:'', phone:'', points:0, cart:[], orderType:'Dine-in', redeem:false, paymentMode:'UPI' };
}

/* -----------------------
   Customer Login modal
   ----------------------- */
function showCustomerLogin(){
  document.getElementById('cust-login-modal').classList.remove('hidden');
  document.getElementById('input-name').value = '';
  document.getElementById('input-phone').value = '';
  document.getElementById('start-order').disabled = true;
  document.getElementById('cust-login-error').classList.add('hidden');
}
function cancelCustomerLogin(){ document.getElementById('cust-login-modal').classList.add('hidden'); returnToMode(); }
document.getElementById('input-name').addEventListener('input', customerLoginInput);
document.getElementById('input-phone').addEventListener('input', customerLoginInput);
function customerLoginInput(){
  const name = document.getElementById('input-name').value.trim();
  const phone = document.getElementById('input-phone').value.replace(/\D/g,'');
  document.getElementById('input-phone').value = phone;
  document.getElementById('start-order').disabled = !(name.length>0 && phone.length===10);
}
function startCustomer(){
  const name = document.getElementById('input-name').value.trim();
  const phone = document.getElementById('input-phone').value.trim();
  if(!name || phone.length!==10){ document.getElementById('cust-login-error').classList.remove('hidden'); return; }
  CUSTOMER.name = name; CUSTOMER.phone = phone;
  const members = loadMembers();
  if(!members[phone]) members[phone] = { name, points: 0, orders: [] };
  CUSTOMER.points = members[phone].points || 0;
  saveMembers(members);
  document.getElementById('cust-login-modal').classList.add('hidden');
  renderCustomerHeader();
  renderProducts();
  renderCart();
}

/* -----------------------
   Products & cart (customer)
   ----------------------- */
function renderCustomerHeader(){
  const el = document.getElementById('cust-top-area');
  el.innerHTML = `<div class="bg-white p-4 rounded-2xl shadow flex justify-between items-center">
    <div>
      <div class="font-semibold">${esc(CUSTOMER.name || 'Guest')}</div>
      <div class="text-sm text-gray-500">+91 ${CUSTOMER.phone || '‚Äî'}</div>
    </div>
    <div class="text-right">
      <div class="text-sm text-gray-500">Points</div>
      <div class="font-bold">${CUSTOMER.points || 0}</div>
    </div>
  </div>`;
  document.getElementById('cust-header-info').innerHTML = CUSTOMER.name ? `<div class="font-semibold">${esc(CUSTOMER.name)}</div><div class="text-xs text-gray-500">Points: ${CUSTOMER.points}</div>` : '';
}

function renderProducts(){
  const juices = loadJuices();
  const area = document.getElementById('product-area');
  const html = juices.map(j => {
    const cartItem = CUSTOMER.cart.find(c=>c.id===j.id);
    const out = j.stock <= 0;
    return `<div class="juice-card bg-white rounded-2xl p-5 shadow">
      <div class="flex items-start gap-4">
        <div class="text-4xl">${j.icon||'üçπ'}</div>
        <div class="flex-1">
          <div class="font-bold text-lg">${esc(j.name)}</div>
          <div class="text-red-500 font-extrabold text-xl">‚Çπ${j.price}</div>
          <div class="text-sm text-gray-500">Stock: ${j.stock}</div>
        </div>
      </div>
      <div class="mt-4">
        ${out ? `<button class="w-full p-2 bg-gray-200 rounded">Out of stock</button>` : cartItem ? `
          <div class="flex items-center gap-3">
            <button class="stepper-btn rounded bg-red-500 text-white" onclick="changeQty(${j.id}, -1)">-</button>
            <div class="font-bold">${cartItem.qty}</div>
            <button class="stepper-btn rounded bg-red-500 text-white" onclick="changeQty(${j.id}, 1)">+</button>
          </div>` : `<button class="w-full p-2 bg-red-500 text-white rounded" onclick="addToCart(${j.id})">Add</button>`
        }
      </div>
    </div>`;
  }).join('');
  area.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${html}</div>`;
}

function addToCart(id){
  const juices = loadJuices();
  const j = juices.find(x=>x.id===id);
  if(!j || j.stock <= 0) { alert('Out of stock'); return; }
  const existing = CUSTOMER.cart.find(c=>c.id===id);
  if(existing) existing.qty++;
  else CUSTOMER.cart.push({ id: j.id, name: j.name, price: j.price, qty:1 });
  renderCart(); renderProducts();
}
function changeQty(id, delta){
  const item = CUSTOMER.cart.find(c=>c.id===id);
  if(!item) return;
  item.qty += delta;
  if(item.qty <= 0) CUSTOMER.cart = CUSTOMER.cart.filter(c=>c.id!==id);
  renderCart(); renderProducts();
}
function renderCart(){
  const container = document.getElementById('cart-list');
  if(!CUSTOMER.cart.length){
    container.innerHTML = `<div class="text-gray-500 py-6 text-center">Cart is empty</div>`;
    document.getElementById('open-checkout-btn').disabled = true;
    return;
  }
  const html = CUSTOMER.cart.map(it => `<div class="flex justify-between items-center">
    <div><div class="font-semibold">${esc(it.name)}</div><div class="text-sm text-gray-500">‚Çπ${it.price} x ${it.qty}</div></div>
    <div class="font-bold">‚Çπ${(it.price*it.qty).toFixed(0)}</div>
  </div>`).join('<hr class="my-2">');
  container.innerHTML = html;
  document.getElementById('open-checkout-btn').disabled = false;
  const subtotal = CUSTOMER.cart.reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = CUSTOMER.orderType === 'Parcel' ? 10 : 0;
  const discount = CUSTOMER.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  document.getElementById('cart-summary').innerHTML = `<div class="text-sm">Subtotal: ‚Çπ${subtotal.toFixed(0)}</div>
    <div class="${parcel? 'text-sm':'hidden'}">Parcel: +‚Çπ10</div>
    <div class="${discount? 'text-sm text-green-600':'hidden'}">Redeem applied: -‚Çπ50</div>
    <div class="mt-2 font-bold text-lg text-red-500">Total: ‚Çπ${total.toFixed(0)}</div>`;
}
function setOrderType(type){
  CUSTOMER.orderType = type;
  document.getElementById('dine-btn').classList.toggle('bg-red-500', type==='Dine-in');
  document.getElementById('dine-btn').classList.toggle('text-white', type==='Dine-in');
  document.getElementById('parcel-btn').classList.toggle('bg-red-500', type==='Parcel');
  document.getElementById('parcel-btn').classList.toggle('text-white', type==='Parcel');
  renderCart();
}

/* -----------------------
   Checkout & Payment
   ----------------------- */
function openCheckout(context='customer'){
  const itemsDiv = document.getElementById('checkout-items');
  itemsDiv.innerHTML = CUSTOMER.cart.map(i=>`<div class="flex justify-between mb-2"><div>${esc(i.name)} x ${i.qty}</div><div>‚Çπ${(i.price*i.qty).toFixed(0)}</div></div>`).join('');
  const radios = document.getElementsByName('co-order-type');
  radios.forEach(r=> r.checked = (r.value === CUSTOMER.orderType));
  const members = loadMembers();
  const mem = members[CUSTOMER.phone] || { points:0 };
  document.getElementById('checkout-redeem').classList.toggle('hidden', !(mem.points >= 100));
  document.getElementById('checkout-redeem-checkbox').checked = CUSTOMER.redeem;
  updateCheckoutSummary();
  document.getElementById('checkout-modal').classList.remove('hidden');
}
function checkoutSetOrderType(type){
  CUSTOMER.orderType = type;
  updateCheckoutSummary();
}
function updateCheckoutSummary(){
  const subtotal = CUSTOMER.cart.reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = CUSTOMER.orderType === 'Parcel' ? 10 : 0;
  const discount = CUSTOMER.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  document.getElementById('checkout-summary').innerHTML = `<div class="text-sm">Subtotal: ‚Çπ${subtotal.toFixed(0)}</div>
    <div class="${parcel? 'text-sm':'hidden'}">Parcel: +‚Çπ10</div>
    <div class="${discount? 'text-sm text-green-600':'hidden'}">Discount: -‚Çπ50</div>
    <div class="mt-2 font-bold text-lg text-red-500">Payable: ‚Çπ${total.toFixed(0)}</div>`;
}
document.getElementById('checkout-redeem-checkbox').addEventListener('change', (e)=> {
  const members = loadMembers();
  const mem = members[CUSTOMER.phone] || { points: 0 };
  if(e.target.checked){
    if((mem.points || 0) < 100){
      alert('Customer does not have 100 points to redeem.');
      e.target.checked = false;
      CUSTOMER.redeem = false;
    } else {
      CUSTOMER.redeem = true;
    }
  } else {
    CUSTOMER.redeem = false;
  }
  updateCheckoutSummary();
  renderCart();
});
function closeCheckout(){ document.getElementById('checkout-modal').classList.add('hidden'); }

function checkoutPayClicked(context='customer'){
  const subtotal = CUSTOMER.cart.reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = CUSTOMER.orderType === 'Parcel' ? 10 : 0;
  const discount = CUSTOMER.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  const id = nextOrderID();
  const order = {
    orderID: id,
    items: CUSTOMER.cart.map(i=>({ id:i.id, name:i.name, qty:i.qty, price:i.price })),
    subtotal, parcel, discount, total,
    orderType: CUSTOMER.orderType,
    redeemed: CUSTOMER.redeem,
    paymentMode: 'UPI',
    customerName: CUSTOMER.name,
    customerPhone: CUSTOMER.phone,
    status: 'pending',
    time: new Date().toISOString()
  };
  const orders = loadOrders(); orders.push(order); saveOrders(orders);

  // reduce stock
  const juices = loadJuices();
  order.items.forEach(it=> {
    const j = juices.find(x=>x.id===it.id); if(j) j.stock = Math.max(0, j.stock - it.qty);
  });
  saveJuices(juices);

  CUSTOMER.cart = []; CUSTOMER.redeem = false; renderCart(); renderProducts(); renderCustomerHeader();
  document.getElementById('checkout-modal').classList.add('hidden');

  document.getElementById('qr-img').src = SAMPLE_QR;
  document.getElementById('qr-amt').innerText = `Amount to pay: ‚Çπ${order.total.toFixed(0)}`;
  document.getElementById('qr-modal').classList.remove('hidden');
  window.lastPlacedOrderId = id;
}

function closeQR(){ document.getElementById('qr-modal').classList.add('hidden'); }
function paymentDone(){
  closeQR();
  const orders = loadOrders();
  const order = orders.find(o => o.orderID === window.lastPlacedOrderId);
  if(!order){ alert('Order not found'); return; }
  const msg = formatBillText(order, false);
  window.open(`https://wa.me/91${order.customerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
  document.getElementById('success-orderid').innerText = 'JH-' + String(order.orderID).padStart(4,'0');
  document.getElementById('success-modal').classList.remove('hidden');
}
function closeSuccess(){ document.getElementById('success-modal').classList.add('hidden'); }

function formatBillText(order, includePointsAfterCompletion){
  const lines = [];
  lines.push('üçπ Juice Hub Bill');
  lines.push('Order ID: JH-' + String(order.orderID).padStart(4,'0'));
  lines.push('--------------------------------');
  order.items.forEach(i => lines.push(`${i.name} x ${i.qty} = ‚Çπ${(i.price*i.qty).toFixed(0)}`));
  if(order.parcel) lines.push('Parcel Charges = ‚Çπ' + order.parcel);
  lines.push('--------------------------------');
  lines.push('Subtotal: ‚Çπ' + order.subtotal.toFixed(0));
  if(order.discount) lines.push('Discount Applied: -‚Çπ' + order.discount);
  lines.push('Final Amount: ‚Çπ' + order.total.toFixed(0));
  lines.push('Payment: ' + order.paymentMode);
  lines.push('Order Type: ' + (order.orderType || 'Dine-in'));
  lines.push('Customer: ' + order.customerName);
  lines.push('Phone: ' + order.customerPhone);
  if(includePointsAfterCompletion){
    const members = loadMembers();
    const mem = members[order.customerPhone] || { points: 0 };
    lines.push('Points Earned: 1 | Total Points: ' + (mem.points || 0));
  } else {
    lines.push('Points Earned: Will be added when order is completed by shop.');
  }
  lines.push('--------------------------------');
  lines.push('Thank you! Visit again üíõ');
  return lines.join('\n');
}

/* -----------------------
   ADMIN: Login & Nav
   ----------------------- */
function adminLogin(){
  const shop = document.getElementById('admin-shopname').value.trim();
  const pass = document.getElementById('admin-pass').value;
  const owner = getOwner();
  if(shop === owner.shop && pass === owner.pass){
    document.getElementById('admin-login-modal').classList.add('hidden');
    document.getElementById('admin-screen').classList.remove('hidden');
    document.getElementById('admin-shop-title').innerText = owner.shop;
    adminNavigate('dashboard');
  } else {
    document.getElementById('admin-login-error').classList.remove('hidden');
  }
}
function closeAdminLogin(){ document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('mode-screen').classList.remove('hidden'); }
function adminLogout(){ document.getElementById('admin-screen').classList.add('hidden'); document.getElementById('mode-screen').classList.remove('hidden'); }

function adminNavigate(section){
  ['dashboard','orders','history','customers','juices','billing'].forEach(k=>{
    const el = document.getElementById('nav-'+k);
    if(el) el.classList.remove('bg-gray-100');
  });
  const btn = document.getElementById('nav-'+section);
  if(btn) btn.classList.add('bg-gray-100');
  if(section==='dashboard') renderAdminDashboard();
  if(section==='orders') renderAdminOrders();
  if(section==='history') renderAdminHistory();
  if(section==='customers') renderAdminCustomers();
  if(section==='juices') renderAdminJuices();
  if(section==='billing') renderAdminBilling();
}

/* Admin Dashboard */
function renderAdminDashboard(){
  const orders = loadOrders();
  const pending = orders.filter(o=>o.status==='pending');
  const completed = orders.filter(o=>o.status==='completed');
  const totalSales = completed.reduce((s,o)=>s + o.total, 0);
  const members = loadMembers();
  document.getElementById('admin-content').innerHTML = `
    <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded shadow"><div class="text-sm text-gray-500">Pending Orders</div><div class="text-xl font-bold">${pending.length}</div></div>
      <div class="bg-white p-4 rounded shadow"><div class="text-sm text-gray-500">Completed Orders</div><div class="text-xl font-bold">${completed.length}</div></div>
      <div class="bg-white p-4 rounded shadow"><div class="text-sm text-gray-500">Total Sales</div><div class="text-xl font-bold">‚Çπ${totalSales.toFixed(0)}</div></div>
      <div class="bg-white p-4 rounded shadow"><div class="text-sm text-gray-500">Customers</div><div class="text-xl font-bold">${Object.keys(members).length}</div></div>
    </div>`;
}

/* Admin Orders */
function renderAdminOrders(){
  const orders = loadOrders().filter(o=>o.status==='pending');
  const container = document.getElementById('admin-content');
  if(!orders.length){
    container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Pending Orders</h2><div class="bg-white p-6 rounded shadow text-center text-gray-500">No pending orders available</div>`;
    return;
  }
  const rows = orders.map(o => `<div class="bg-white p-4 rounded mb-3 flex justify-between">
    <div>
      <div class="font-semibold">JH-${String(o.orderID).padStart(4,'0')} ‚Ä¢ ${esc(o.customerName)}</div>
      <div class="text-sm text-gray-500">${esc(o.customerPhone)} ‚Ä¢ ${new Date(o.time).toLocaleString()}</div>
      <div class="text-sm mt-2">${o.items.map(i=>esc(i.name)+' x'+i.qty).join(', ')}</div>
    </div>
    <div class="text-right">
      <div class="font-bold">‚Çπ${o.total.toFixed(0)}</div>
      <div class="mt-2 flex gap-2 justify-end">
        <button class="px-3 py-1 bg-green-500 text-white rounded" onclick="adminComplete(${o.orderID})">Complete</button>
        <button class="px-3 py-1 border rounded" onclick="adminCancel(${o.orderID})">Cancel</button>
      </div>
    </div>
  </div>`).join('');
  container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Pending Orders</h2>${rows}`;
}

function adminComplete(orderId){
  if(!confirm('Mark order JH-' + String(orderId).padStart(4,'0') + ' as completed?')) return;
  const orders = loadOrders();
  const o = orders.find(x=>x.orderID === orderId);
  if(!o) return alert('Order not found');
  o.status = 'completed';
  saveOrders(orders);
  // award points
  const members = loadMembers();
  if(o.customerPhone && o.customerPhone !== 'N/A'){
    const mem = members[o.customerPhone] || { name: o.customerName, points:0, orders:[] };
    if(o.redeemed) mem.points = Math.max(0, (mem.points || 0) - 100) + 1;
    else mem.points = (mem.points || 0) + 1;
    mem.orders = mem.orders || [];
    if(!mem.orders.includes(orderId)) mem.orders.push(orderId);
    members[o.customerPhone] = mem;
    saveMembers(members);
  }
  alert('Order completed and points updated.');
  adminNavigate('orders');
}

function adminCancel(orderId){
  if(!confirm('Cancel order JH-' + String(orderId).padStart(4,'0') + '?')) return;
  let orders = loadOrders();
  const idx = orders.findIndex(x=>x.orderID === orderId);
  if(idx === -1) return alert('Not found');
  const o = orders[idx];
  const juices = loadJuices();
  o.items.forEach(it=>{
    const j = juices.find(x=>x.id===it.id);
    if(j) j.stock = (j.stock || 0) + it.qty;
  });
  saveJuices(juices);
  orders[idx].status = 'canceled';
  saveOrders(orders);
  alert('Order canceled');
  adminNavigate('orders');
}

/* Admin History */
function renderAdminHistory(){
  const orders = loadOrders().slice().reverse();
  const container = document.getElementById('admin-content');
  if(!orders.length){
    container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Order History</h2><div class="bg-white p-6 rounded shadow text-center text-gray-500">No orders yet</div>`;
    return;
  }
  const rows = orders.map(o => `<tr class="border-t">
    <td class="p-3">JH-${String(o.orderID).padStart(4,'0')}</td>
    <td class="p-3">${esc(o.customerName)}<br><span class="text-xs text-gray-500">+91 ${esc(o.customerPhone)}</span></td>
    <td class="p-3">${o.items.map(i=>esc(i.name)+' x'+i.qty).join('<br>')}</td>
    <td class="p-3">‚Çπ${o.total.toFixed(0)}</td>
    <td class="p-3">${esc(o.paymentMode)}</td>
    <td class="p-3">${new Date(o.time).toLocaleString()}</td>
    <td class="p-3">${esc(o.status)}</td>
  </tr>`).join('');
  container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Order History</h2>
    <div class="bg-white p-4 rounded shadow overflow-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr>
    <th class="p-3 text-left">Order</th><th class="p-3 text-left">Customer</th><th class="p-3">Items</th><th class="p-3">Total</th><th class="p-3">Payment</th><th class="p-3">Date</th><th class="p-3">Status</th>
    </tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* Admin Customers */
function renderAdminCustomers(){
  const members = loadMembers();
  const keys = Object.keys(members);
  const container = document.getElementById('admin-content');
  if(!keys.length){
    container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Customers</h2><div class="bg-white p-6 rounded shadow text-center text-gray-500">No customers yet</div>`;
    return;
  }
  const rows = keys.map(phone=> {
    const m = members[phone];
    const totalOrders = (m.orders||[]).length;
    return `<div class="bg-white p-3 rounded mb-3 flex justify-between items-center">
      <div><div class="font-semibold">${esc(m.name)}</div><div class="text-sm text-gray-500">+91 ${phone}</div></div>
      <div class="text-right">
        <div>Points: <strong>${m.points||0}</strong></div>
        <div class="text-sm text-gray-500">Orders: ${totalOrders}</div>
        <div class="mt-2"><button class="px-3 py-1 border rounded" onclick="viewCustomerOrders('${phone}')">View Orders</button></div>
      </div>
    </div>`;
  }).join('');
  container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Customers</h2>${rows}`;
}
function viewCustomerOrders(phone){
  const members = loadMembers(); const m = members[phone];
  if(!m) return alert('No such customer');
  const orders = loadOrders().filter(o=>o.customerPhone === phone).reverse();
  const list = orders.map(o=>`<div class="bg-white p-3 rounded mb-2 flex justify-between">
    <div><div class="font-semibold">JH-${String(o.orderID).padStart(4,'0')} ‚Ä¢ ${new Date(o.time).toLocaleString()}</div><div class="text-sm text-gray-500">${o.items.map(i=>esc(i.name)+' x'+i.qty).join(', ')}</div></div>
    <div class="text-right"><div class="font-bold">‚Çπ${o.total.toFixed(0)}</div><div class="text-sm text-gray-500">${o.status}</div></div>
  </div>`).join('') || '<div class="text-gray-500 p-4">No orders</div>';
  document.getElementById('admin-content').innerHTML = `<button class="mb-3 px-3 py-1 border rounded" onclick="adminNavigate('customers')">‚Üê Back</button><h3 class="text-xl font-bold mb-2">${esc(m.name)} ‚Äî +91 ${phone}</h3>${list}`;
}

/* Admin Juices */
function renderAdminJuices(){
  const juices = loadJuices();
  const rows = juices.map(j=>`<div class="bg-white p-3 rounded mb-3 flex justify-between items-center">
    <div><div class="font-semibold">${esc(j.name)} ${j.icon||''}</div><div class="text-sm text-gray-500">Price: ‚Çπ${j.price} ‚Ä¢ Stock: ${j.stock}</div></div>
    <div class="flex gap-2">
      <button class="px-3 py-1 border rounded" onclick="editJuice(${j.id})">Edit</button>
      <button class="px-3 py-1 border rounded" onclick="deleteJuice(${j.id})">Delete</button>
    </div>
  </div>`).join('');
  document.getElementById('admin-content').innerHTML = `<h2 class="text-2xl font-bold mb-4">Juices Inventory</h2>
    <div class="mb-4"><button class="px-4 py-2 bg-green-600 text-white rounded" onclick="showAddJuice()">Add New Juice</button></div>
    ${rows || '<div class="bg-white p-6 rounded shadow text-center text-gray-500">No juices</div>'}`;
}
function showAddJuice(){
  document.getElementById('admin-content').innerHTML = `<h2 class="text-2xl font-bold mb-4">Add New Juice</h2>
    <div class="bg-white p-4 rounded shadow max-w-xl">
      <input id="new-name" class="w-full border p-2 rounded mb-2" placeholder="Name">
      <input id="new-price" class="w-full border p-2 rounded mb-2" placeholder="Price">
      <input id="new-stock" class="w-full border p-2 rounded mb-2" placeholder="Stock">
      <input id="new-icon" class="w-full border p-2 rounded mb-2" placeholder="Icon (emoji)">
      <div class="flex gap-2">
        <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="saveNewJuice()">Save</button>
        <button class="px-3 py-2 border rounded" onclick="renderAdminJuices()">Cancel</button>
      </div>
    </div>`;
}
function saveNewJuice(){
  const name = document.getElementById('new-name').value.trim();
  const price = Number(document.getElementById('new-price').value);
  const stock = Number(document.getElementById('new-stock').value);
  const icon = document.getElementById('new-icon').value.trim() || 'üçπ';
  if(!name || isNaN(price) || isNaN(stock)) return alert('Please fill correct values');
  const juices = loadJuices();
  const id = juices.length ? Math.max(...juices.map(j=>j.id)) + 1 : 1;
  juices.push({ id, name, price, stock, icon });
  saveJuices(juices);
  renderAdminJuices();
}
function editJuice(id){
  const juices = loadJuices(); const j = juices.find(x=>x.id===id); if(!j) return alert('Not found');
  document.getElementById('admin-content').innerHTML = `<h2 class="text-2xl font-bold mb-4">Edit Juice</h2>
    <div class="bg-white p-4 rounded shadow max-w-xl">
      <input id="edit-name" class="w-full border p-2 rounded mb-2" value="${esc(j.name)}">
      <input id="edit-price" class="w-full border p-2 rounded mb-2" value="${j.price}">
      <input id="edit-stock" class="w-full border p-2 rounded mb-2" value="${j.stock}">
      <input id="edit-icon" class="w-full border p-2 rounded mb-2" value="${esc(j.icon||'')}">
      <div class="flex gap-2">
        <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="saveEditJuice(${j.id})">Save</button>
        <button class="px-3 py-2 border rounded" onclick="renderAdminJuices()">Cancel</button>
      </div>
    </div>`;
}
function saveEditJuice(id){
  const name = document.getElementById('edit-name').value.trim();
  const price = Number(document.getElementById('edit-price').value);
  const stock = Number(document.getElementById('edit-stock').value);
  const icon = document.getElementById('edit-icon').value.trim() || 'üçπ';
  if(!name || isNaN(price) || isNaN(stock)) return alert('Invalid');
  const juices = loadJuices(); const idx = juices.findIndex(x=>x.id===id);
  juices[idx] = { id, name, price, stock, icon }; saveJuices(juices); renderAdminJuices();
}
function deleteJuice(id){ if(!confirm('Delete this juice?')) return; let juices = loadJuices(); juices = juices.filter(x=>x.id!==id); saveJuices(juices); renderAdminJuices(); }

/* -----------------------
   Admin Billing (start popup & UI)
   ----------------------- */
function renderAdminBilling(){
  // Start with popup to enter customer details
  showAdminBillingStart();
}

/* Show popup modal - admin billing start */
function showAdminBillingStart(){
  // if overlay exists, remove first
  const existing = document.getElementById('admin-billing-start-overlay');
  if(existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'admin-billing-start-overlay';
  overlay.className = 'fixed inset-0 modal-bg center-modal p-4';
  overlay.innerHTML = `
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <h3 class="text-2xl font-bold mb-2" style="color:var(--primary)">Billing ‚Äî Enter customer</h3>
      <p class="text-gray-600 mb-4">Enter customer name & phone (for points & history).</p>
      <input id="admin-bill-name" class="w-full border rounded p-3 mb-3" placeholder="Customer name">
      <input id="admin-bill-phone" class="w-full border rounded p-3 mb-3" placeholder="10-digit mobile (optional)">
      <div class="flex gap-3">
        <button id="admin-start-billing-btn" class="flex-1 bg-red-500 text-white p-3 rounded">Start Billing</button>
        <button class="flex-1 border p-3 rounded" id="admin-cancel-billing-btn">Cancel</button>
      </div>
      <p id="admin-billing-error" class="text-red-500 text-sm mt-3 hidden">Please enter valid name & optional 10-digit phone.</p>
    </div>
  `;
  document.body.appendChild(overlay);

  // Hook events
  document.getElementById('admin-start-billing-btn').onclick = startAdminBilling;
  document.getElementById('admin-cancel-billing-btn').onclick = function(){ overlay.remove(); adminNavigate('billing'); };
}

/* startAdminBilling function (works and was requested) */
function startAdminBilling(){
  const name = document.getElementById('admin-bill-name').value.trim();
  const phoneRaw = document.getElementById('admin-bill-phone').value.replace(/\D/g,'');
  const phone = phoneRaw.length === 10 ? phoneRaw : null;
  if(!name){
    document.getElementById('admin-billing-error').classList.remove('hidden');
    return;
  }
  // create ADMIN_BILL state on window
  window.ADMIN_BILL = {
    name,
    phone,
    points: 0,
    cart: [],
    orderType: 'Dine-in',
    redeem: false
  };
  if(phone){
    const members = loadMembers();
    if(!members[phone]) members[phone] = { name, points: 0, orders: [] };
    window.ADMIN_BILL.points = members[phone].points || 0;
    saveMembers(members);
  }
  // remove overlay
  const overlay = document.getElementById('admin-billing-start-overlay');
  if(overlay) overlay.remove();
  // render billing UI inside admin-content (same style as customer)
  renderAdminBillingUI();
}

/* Render Admin Billing UI (cards + order panel) */
function renderAdminBillingUI(){
  const juices = loadJuices();
  const productCards = juices.map(j=> {
    const inCart = (window.ADMIN_BILL.cart || []).find(c=>c.id===j.id);
    const out = j.stock <= 0;
    return `<div class="juice-card bg-white rounded-2xl p-5 shadow">
      <div class="flex items-start gap-4">
        <div class="text-4xl">${j.icon||'üçπ'}</div>
        <div class="flex-1">
          <div class="font-bold text-lg">${esc(j.name)}</div>
          <div class="text-red-500 font-extrabold text-xl">‚Çπ${j.price}</div>
          <div class="text-sm text-gray-500">Stock: ${j.stock}</div>
        </div>
      </div>
      <div class="mt-4">
        ${out? `<button class="w-full p-2 bg-gray-200 rounded">Out of stock</button>` : inCart ? `
          <div class="flex items-center gap-3">
            <button class="stepper-btn rounded bg-red-500 text-white" onclick="adminBillingChangeQty(${j.id}, -1)">-</button>
            <div class="font-bold">${inCart.qty}</div>
            <button class="stepper-btn rounded bg-red-500 text-white" onclick="adminBillingChangeQty(${j.id}, 1)">+</button>
          </div>` : `<button class="w-full p-2 bg-red-500 text-white rounded" onclick="adminBillingAddToCart(${j.id})">Add</button>`}
      </div>
    </div>`;
  }).join('');

  document.getElementById('admin-content').innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
      <div class="md:col-span-8 lg:col-span-9">
        <div class="bg-white p-4 rounded-2xl shadow mb-4 flex justify-between items-center">
          <div>
            <div class="font-semibold">${esc(window.ADMIN_BILL.name)}</div>
            <div class="text-sm text-gray-500">${window.ADMIN_BILL.phone ? '+91 ' + window.ADMIN_BILL.phone : 'Walk-in (no phone)'}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">Points</div>
            <div class="font-bold">${window.ADMIN_BILL.points || 0}</div>
          </div>
        </div>

        <div class="mb-4 flex gap-3">
          <div class="bg-white p-4 rounded-2xl shadow flex items-center gap-4">
            <div class="font-semibold">Order Type:</div>
            <div class="flex items-center gap-2">
              <button id="admin-dine-btn" onclick="adminBillingSetOrderType('Dine-in')" class="px-4 py-2 rounded-lg border bg-white">Dine-in</button>
              <button id="admin-parcel-btn" onclick="adminBillingSetOrderType('Parcel')" class="px-4 py-2 rounded-lg border bg-white">Parcel (+‚Çπ10)</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${productCards}</div>
      </div>

      <aside class="md:col-span-4 lg:col-span-3">
        <div class="bg-white rounded-2xl shadow p-4 sticky top-6">
          <h3 class="font-bold text-lg">Order</h3>
          <div id="admin-bill-cart" class="mt-3 space-y-3"></div>
          <div id="admin-bill-summary" class="mt-4 text-sm"></div>
          <div class="mt-4 space-y-2">
            <button class="w-full bg-red-500 text-white p-3 rounded-lg" onclick="adminBillingOpenCheckout()">Checkout</button>
            <button class="w-full border p-2 rounded" onclick="adminNavigate('billing')">Cancel Billing</button>
          </div>
        </div>
      </aside>
    </div>
  `;
  adminBillingSetOrderType(window.ADMIN_BILL.orderType || 'Dine-in');
  adminBillingRenderCart();
}

/* Admin billing cart ops */
function adminBillingAddToCart(id){
  const juices = loadJuices();
  const j = juices.find(x=>x.id===id); if(!j || j.stock<=0) return alert('Out of stock');
  window.ADMIN_BILL.cart = window.ADMIN_BILL.cart || [];
  const existing = window.ADMIN_BILL.cart.find(c=>c.id===id);
  if(existing) existing.qty++;
  else window.ADMIN_BILL.cart.push({ id: j.id, name: j.name, price: j.price, qty:1 });
  adminBillingRenderCart();
  renderAdminBillingUI();
}
function adminBillingChangeQty(id, delta){
  const item = (window.ADMIN_BILL.cart||[]).find(c=>c.id===id); if(!item) return;
  item.qty += delta; if(item.qty<=0) window.ADMIN_BILL.cart = window.ADMIN_BILL.cart.filter(c=>c.id!==id);
  adminBillingRenderCart(); renderAdminBillingUI();
}
function adminBillingRenderCart(){
  const cont = document.getElementById('admin-bill-cart'); if(!cont) return;
  const items = window.ADMIN_BILL.cart || [];
  if(!items.length){ cont.innerHTML = '<div class="text-gray-500 py-6 text-center">Cart is empty</div>'; document.getElementById('admin-bill-summary').innerHTML=''; return; }
  cont.innerHTML = items.map(it => `<div class="flex justify-between items-center"><div><div class="font-semibold">${esc(it.name)}</div><div class="text-sm text-gray-500">‚Çπ${it.price} x ${it.qty}</div></div><div class="font-bold">‚Çπ${(it.price*it.qty).toFixed(0)}</div></div>`).join('<hr class="my-2">');
  const subtotal = items.reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = window.ADMIN_BILL.orderType === 'Parcel' ? 10 : 0;
  const discount = window.ADMIN_BILL.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  document.getElementById('admin-bill-summary').innerHTML = `<div class="text-sm">Subtotal: ‚Çπ${subtotal.toFixed(0)}</div>
    <div class="${parcel? 'text-sm':'hidden'}">Parcel: +‚Çπ10</div>
    <div class="${discount? 'text-sm text-green-600':'hidden'}">Redeem applied: -‚Çπ50</div>
    <div class="mt-2 font-bold text-lg text-red-500">Total: ‚Çπ${total.toFixed(0)}</div>`;
}
function adminBillingSetOrderType(type){
  window.ADMIN_BILL.orderType = type;
  const dineBtn = document.getElementById('admin-dine-btn');
  const parcelBtn = document.getElementById('admin-parcel-btn');
  if(dineBtn && parcelBtn){
    dineBtn.classList.toggle('bg-red-500', type==='Dine-in'); dineBtn.classList.toggle('text-white', type==='Dine-in');
    parcelBtn.classList.toggle('bg-red-500', type==='Parcel'); parcelBtn.classList.toggle('text-white', type==='Parcel');
  }
  adminBillingRenderCart();
}

/* Admin checkout (uses same modal but admin context) */
function adminBillingOpenCheckout(){
  const itemsDiv = document.getElementById('checkout-items');
  itemsDiv.innerHTML = (window.ADMIN_BILL.cart || []).map(i=>`<div class="flex justify-between mb-2"><div>${esc(i.name)} x ${i.qty}</div><div>‚Çπ${(i.price*i.qty).toFixed(0)}</div></div>`).join('');
  const radios = document.getElementsByName('co-order-type'); radios.forEach(r=> r.checked = (r.value === window.ADMIN_BILL.orderType));
  document.getElementById('checkout-redeem').classList.toggle('hidden', ! (window.ADMIN_BILL.points >= 100));
  document.getElementById('checkout-redeem-checkbox').checked = window.ADMIN_BILL.redeem;
  // change redeem handler to admin flow for this checkout
  document.getElementById('checkout-redeem-checkbox').onchange = function(e){
    if(e.target.checked){
      if((window.ADMIN_BILL.points || 0) < 100){ alert('Customer does not have 100 points to redeem.'); e.target.checked = false; window.ADMIN_BILL.redeem = false; }
      else window.ADMIN_BILL.redeem = true;
    } else { window.ADMIN_BILL.redeem = false; }
    updateCheckoutSummaryAdmin();
    adminBillingRenderCart();
  };
  updateCheckoutSummaryAdmin();
  document.getElementById('checkout-pay-btn').onclick = function(){ adminBillingProcess(); };
  document.getElementById('checkout-modal').classList.remove('hidden');
}
function updateCheckoutSummaryAdmin(){
  const subtotal = (window.ADMIN_BILL.cart || []).reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = window.ADMIN_BILL.orderType === 'Parcel' ? 10 : 0;
  const discount = window.ADMIN_BILL.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  document.getElementById('checkout-summary').innerHTML = `<div class="text-sm">Subtotal: ‚Çπ${subtotal.toFixed(0)}</div>
    <div class="${parcel? 'text-sm':'hidden'}">Parcel: +‚Çπ10</div>
    <div class="${discount? 'text-sm text-green-600':'hidden'}">Discount: -‚Çπ50</div>
    <div class="mt-2 font-bold text-lg text-red-500">Payable: ‚Çπ${total.toFixed(0)}</div>`;
}
function checkoutSetOrderType(type){
  if(MODE === 'admin' && window.ADMIN_BILL) {
    window.ADMIN_BILL.orderType = type; updateCheckoutSummaryAdmin(); adminBillingRenderCart();
  } else {
    CUSTOMER.orderType = type; updateCheckoutSummary(); renderCart();
  }
}
function closeCheckout(){ document.getElementById('checkout-modal').classList.add('hidden'); }

/* Admin finalize billing (walk-in) */
function adminBillingProcess(){
  const items = window.ADMIN_BILL.cart || [];
  if(!items.length) return alert('No items');
  const subtotal = items.reduce((s,i)=>s + i.price*i.qty, 0);
  const parcel = window.ADMIN_BILL.orderType === 'Parcel' ? 10 : 0;
  const discount = window.ADMIN_BILL.redeem ? 50 : 0;
  const total = Math.max(0, subtotal + parcel - discount);
  const id = nextOrderID();
  const order = {
    orderID: id,
    items: items.map(i=>({ id:i.id, name:i.name, qty:i.qty, price:i.price })),
    subtotal, parcel, discount, total,
    orderType: window.ADMIN_BILL.orderType,
    redeemed: window.ADMIN_BILL.redeem,
    paymentMode: 'Cash (Admin)',
    customerName: window.ADMIN_BILL.name,
    customerPhone: window.ADMIN_BILL.phone || 'N/A',
    status: 'completed',
    time: new Date().toISOString()
  };
  const orders = loadOrders(); orders.push(order); saveOrders(orders);
  // update stock
  const juices = loadJuices();
  order.items.forEach(it=>{
    const j = juices.find(x=>x.id===it.id); if(j) j.stock = Math.max(0, j.stock - it.qty);
  });
  saveJuices(juices);
  // update member points if phone present
  if(window.ADMIN_BILL.phone){
    const members = loadMembers();
    const mem = members[window.ADMIN_BILL.phone] || { name: window.ADMIN_BILL.name, points:0, orders:[] };
    if(order.redeemed) mem.points = Math.max(0, (mem.points || 0) - 100) + 1;
    else mem.points = (mem.points || 0) + 1;
    mem.orders = mem.orders || []; mem.orders.push(id);
    members[window.ADMIN_BILL.phone] = mem; saveMembers(members);
  }
  const msg = formatBillText(order, true);
  if(order.customerPhone && order.customerPhone !== 'N/A') window.open(`https://wa.me/91${order.customerPhone}?text=${encodeURIComponent(msg)}`, '_blank');
  alert('Bill generated JH-' + String(id).padStart(4,'0'));
  window.ADMIN_BILL = null;
  adminNavigate('history');
}

/* -----------------------
   Utilities & init
   ----------------------- */
function loadJuices(){ return JSON.parse(localStorage.getItem(LS.JUICES) || '[]'); }
function saveJuices(arr){ localStorage.setItem(LS.JUICES, JSON.stringify(arr)); }
function loadMembers(){ return JSON.parse(localStorage.getItem(LS.MEMBERS) || '{}'); }
function saveMembers(map){ localStorage.setItem(LS.MEMBERS, JSON.stringify(map)); }
function loadOrders(){ return JSON.parse(localStorage.getItem(LS.ORDERS) || '[]'); }
function saveOrders(arr){ localStorage.setItem(LS.ORDERS, JSON.stringify(arr)); }
function getOwner(){ return JSON.parse(localStorage.getItem(LS.OWNER) || '{}'); }

document.addEventListener('DOMContentLoaded', ()=> {
  // ready
});
</script>
</body>
</html>
